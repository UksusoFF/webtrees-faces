!function(e){var a=e.mapster.utils;function o(o,t,n,c,i){if(e.isArray(t)&&(t=t[0]),t&&"AREA"===t.nodeName&&"rect"===t.shape){var s=function(e,o,t,n){var c=a.split(e.coords,parseInt),i=c[0],s=c[1],r=c[2],f=c[3],l=r-i,d=n.outerWidth(!0),p=n.outerHeight(!0),u=i+l/2,m=0;u-d/2>0&&(m=u-d/2),u+d/2>o.width&&(m=o.width-d);var h=f;return h+p>o.height&&(h=s-p),[m,h]}(t,n,e(".faces-mapster-wrapper"),o);return o.css({left:s[0]+"px",top:s[1]+"px",opacity:1})}console.error("Unexpected behavior!")}function t(a,o,t,n,c,i){var s=t+".mapster-tooltip";if(e.inArray(o,a)>=0)return n.unbind(s).bind(s,function(e){c&&!c.call(this,e)||(n.unbind(".mapster-tooltip"),i&&i.call(this))}),{object:n,event:s}}e.mapster.AreaData.prototype.showToolTip=function(n,c){var i,s,r,f,l,d=this,p=d.owner,u=d.effectiveOptions();if(c=c?e.extend({},c):{},n=n||u.toolTip,s=c.closeEvents||u.toolTipClose||p.options.toolTipClose||"tooltip-click",l=void 0!==c.template?c.template:p.options.toolTipContainer,c.closeEvents="string"==typeof s?s=a.split(s):s,c.fadeDuration=c.fadeDuration||(p.options.toolTipFade?p.options.fadeDuration||u.fadeDuration:0),r=d.area?d.area:e.map(d.areas(),function(e){return e.area}),p.activeToolTipID!==d.areaId)return p.clearToolTip(),p.activeToolTip=i=function(a,o,t){var n;return o?(n="string"==typeof o?e(o):e(o).clone()).append(a):n=e(a),n.css(e.extend(t||{},{display:"block",position:"absolute",opacity:0})),e(".faces-mapster-wrapper").append(n),n}(n,l,c.css),p.activeToolTipID=d.areaId,f=function(){p.clearToolTip()},t(s,"area-click","click",e(p.map),null,f),t(s,"tooltip-click","click",i,null,f),t(s,"image-mouseout","mouseout",e(p.image),function(e){return e.relatedTarget&&"AREA"!==e.relatedTarget.nodeName&&e.relatedTarget!==d.area},f),o(i,r,p.image,c.container,0),a.ifFunction(p.options.onShowToolTip,d.area,{toolTip:i,options:{},areaOptions:u,key:d.key,selected:d.isSelected()}),i}}(jQuery);var facesMid=null,facesFact=null,facesMode="mark",facesIsMobile=null!==new MobileDetect(window.navigator.userAgent).mobile();function facesRoute(e,a){return window.WT_FACES.routes[e].replace("FACES_ACTION",a)}function facesIndex(e,a){facesMid=e,facesFact=a,$.ajax({url:facesRoute("data","index"),type:"GET",data:{mid:e,fact:a}}).done(function(e){facesRenderPeoples(e.map,e.edit,e.title,e.meta)})}function facesAttach(e,a,o,t){$.ajax({url:facesRoute("data","attach"),type:"POST",data:{mid:e,fact:a,pid:o.pid,coords:o.coords}}).done(function(e){facesRefresh(),t&&null!==e.linker&&$.ajax({url:e.linker.url,type:"POST",data:e.linker.data})})}function facesDetach(e,a,o){$.ajax({url:facesRoute("data","detach"),type:"POST",data:{mid:e,fact:a,pid:o.pid}}).done(function(){facesRefresh()})}function facesRefresh(){var e=$.fancybox.getInstance();e.jumpTo(e.currIndex)}function facesClean(e){var a=e.$refs.stage.find(".fancybox-slide--current img.fancybox-image");a.length&&(a.mapster("tooltip"),a.mapster("unbind"),a.parents("pinch-zoom").length&&a.unwrap("pinch-zoom")),$("#faces-map").remove()}function facesRenderPeoples(e,a,o,t){var n=$.fancybox.getInstance(),c=n.$refs.caption.find(".fancybox-caption__body"),i=n.$refs.stage.find(".fancybox-slide--current img.fancybox-image");n.$refs.container.toggleClass("faces-readonly",!(a&&!facesIsMobile));var s="faces-map-"+Date.now(),r=$("<map/>",{id:"faces-map",name:s}),f=[],l=[];i.attr("usemap","#"+s).after(r),$.each(e,function(e,o){var t=null!==o.link?o.link:"#",n=encodeURIComponent(o.pid);r.append($("<area/>",{shape:o.coords.length>4?"poly":"rect",coords:o.coords.join(","),href:t,"data-key":n})),f.push({key:n,toolTip:tmpl($("#faces-tooltip-template").html(),{person:o})});var c=tmpl($("#faces-person-template").html(),{person:o,key:n,link:t,edit:a&&!facesIsMobile});l.push(c)}),i.mapster({isSelectable:!1,wrapClass:"faces-mapster-wrapper",mapKey:"data-key",fillColor:"000000",fillOpacity:0,stroke:!0,strokeColor:"3b5998",strokeWidth:2,showToolTip:!0,areas:f,toolTipContainer:'<div class="faces-tooltip"></div>',toolTipClose:facesIsMobile?"area-mouseout":["area-mouseout","image-mouseout"],onClick:facesIsMobile?null:function(e){var a=$(e.e.target).attr("href");return"#"!==a&&(window.location=a),!1}});var d=$("<div>");f.length&&d.html(l.join("")),$.each(t,function(e,a){$.each(a,function(e,a){d.prepend('<div class="faces-subtitle">'+a+"</div>")})}),d.prepend('<div class="faces-title">'+o+"</div>"),c.empty(),c.append(d),facesBindCaptionActions(i,n),facesBindToolbarActions(i,n)}function facesRenderZoom(){var e=$.fancybox.getInstance(),a=e.$refs.stage.find(".fancybox-slide--current img.fancybox-image");a.wrap("<pinch-zoom></pinch-zoom>"),facesBindToolbarActions(a,e)}function facesBindCaptionActions(e,a){a.$refs.caption.find(".faces-person-name").on("mouseenter",function(a){var o=$(a.target).data("key");e.mapster("highlight",o),e.mapster("tooltip",o)}),a.$refs.caption.find(".faces-person-name").on("mouseleave",function(){e.mapster("highlight",!1),e.mapster("tooltip",!1)}),a.$refs.caption.find(".faces-person-detach").on("click",function(a){var o=$(a.target),t=$(tmpl($("#faces-detach-modal-template").html(),{name:o.data("name")}));t.on("shown.bs.modal",function(){e.mapster("tooltip"),$(".modal-backdrop").before(t)}),t.on("hidden.bs.modal",function(){t.remove()}),t.find("#faces-detach-button").on("click",function(){var e=o.data("pid");e&&facesDetach(facesMid,facesFact,{pid:e}),t.modal("hide")}),$("body").append(t),t.modal("show")})}function facesBindToolbarActions(e,a){a.$refs.toolbar.find("[data-fancybox-fzoom]").off("click").on("click",function(){facesMode="mark"===facesMode?"zoom":"mark",facesRefresh()}),a.$refs.toolbar.find("[data-fancybox-fconfig]").off("click").on("click",function(){window.location=facesRoute("admin","config")+"&mid="+facesMid}),a.$refs.toolbar.find("[data-fancybox-fadd]").off("click").on("click",function(){a.$refs.container.toggleClass("faces-select",!0);var o=e.imgAreaSelect({handles:!1,autoHide:!0,show:!0,instance:!0,parent:e.parents(".fancybox-content"),imageHeight:e.get(0).naturalHeight,imageWidth:e.get(0).naturalWidth,onSelectEnd:function(t,n){a.$refs.container.toggleClass("faces-select",!1);var c=$($("#faces-attach-modal-template").html());c.on("shown.bs.modal",function(){e.mapster("tooltip"),$(".modal-backdrop").before(c)}),c.on("hidden.bs.modal",function(){c.remove()}),c.find("select.select2").select2({dropdownParent:c,width:"100%",tags:!0,escapeMarkup:function(e){return e}}),c.find("#faces-attach-button").on("click",function(){var e=c.find("#faces-attach-pid").find(":selected");e.length&&e.val()&&facesAttach(facesMid,facesFact,{pid:e.val(),coords:[n.x1,n.y1,n.x2,n.y2]},!e.is('[data-select2-tag="true"]')),c.modal("hide")}),$("body").append(c),c.modal("show"),o.cancelSelection(),o.remove()}})})}$.colorbox.remove(),$("body").off("click","a.gallery"),$.fancybox.defaults.btnTpl.fzoom=$.fancybox.defaults.btnTpl.zoom.replace(/zoom/g,"fzoom"),$.fancybox.defaults.btnTpl.fadd=$.fancybox.defaults.btnTpl.close.replace(/close/g,"fadd").replace("{{CLOSE}}","Add"),$.fancybox.defaults.btnTpl.fconfig='<button data-fancybox-fconfig class="fancybox-button fancybox-button--fconfig" title="Settings" style="padding: 14px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M507.73 109.1c-2.24-9.03-13.54-12.09-20.12-5.51l-74.36 74.36-67.88-11.31-11.31-67.88 74.36-74.36c6.62-6.62 3.43-17.9-5.66-20.16-47.38-11.74-99.55.91-136.58 37.93-39.64 39.64-50.55 97.1-34.05 147.2L18.74 402.76c-24.99 24.99-24.99 65.51 0 90.5 24.99 24.99 65.51 24.99 90.5 0l213.21-213.21c50.12 16.71 107.47 5.68 147.37-34.22 37.07-37.07 49.7-89.32 37.91-136.73zM64 472c-13.25 0-24-10.75-24-24 0-13.26 10.75-24 24-24s24 10.74 24 24c0 13.25-10.75 24-24 24z"></path></svg></button>',$().fancybox({selector:"a[type^=image].gallery",baseClass:"fancybox-faces-layout",infobar:!1,protect:!1,touch:{vertical:!1},buttons:["close","slideShow","fzoom","fadd","fconfig"],animationEffect:"fade",transitionEffect:"fade",preventCaptionOverlap:!1,idleTime:!1,gutter:0,clickOutside:!1,clickSlide:!1,trapFocus:!1,clickContent:!1,wheel:!1,beforeLoad:function(e){e.$refs.container.toggleClass("faces-zoom","mark"!==facesMode)},beforeClose:function(e){facesClean(e)},beforeShow:function(e){e.$refs.container.toggleClass("faces-zoom","mark"!==facesMode),facesClean(e)},afterShow:function(e,a){var o=new RegExp("[?&]xref=([^&#]*)").exec(a.src)[1],t=new RegExp("[?&]fact_id=([^&#]*)").exec(a.src)[1];"mark"===facesMode?(a.opts.caption='<div class="fancybox-loading"></div>',e.updateControls(),facesIndex(o,t)):facesRenderZoom()}});
